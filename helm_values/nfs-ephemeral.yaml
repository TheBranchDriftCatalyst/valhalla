# wget https://raw.githubusercontent.com/democratic-csi/charts/master/stable/democratic-csi/examples/freenas-nfs.yaml -O - | sed '/INLINE/,$d' > nfs.yaml
# wget https://raw.githubusercontent.com/democratic-csi/democratic-csi/master/examples/freenas-api-nfs.yaml -O - | sed -e 's/^/    /g' >> nfs.yaml
---
csiDriver:
  # should be globally unique for a given cluster
  name: "org.democratic-csi.nfs"

storageClasses:
- name: nfs-ephemeral
  defaultClass: true
  reclaimPolicy: Delete
  volumeBindingMode: Immediate
  allowVolumeExpansion: true
  parameters:
    fsType: nfs

  mountOptions:
  - noatime
  - nfsvers=4
  secrets:
    provisioner-secret:
    controller-publish-secret:
    node-stage-secret:
    node-publish-secret:
    controller-expand-secret:

driver:
  config:
    driver: freenas-nfs
    instance_id:
    httpConnection:
      protocol: http
      host: "{{ env TRUENAS_HOSTNAME }}"
      port: 80
      username: "{{ env TRUENAS_USERNAME }}"
      password: "{{ env TRUENAS_PASSWORD }}"
      # apiKey: "{{ env TRUENAS_API_KEY }}"
      allowInsecure: true
    sshConnection:
      host: "{{ env TRUENAS_HOSTNAME }}"
      port: 22
      username: "{{ env TRUENAS_USERNAME }}"
      password: "{{ env TRUENAS_PASSWORD }}"
        #      privateKey: |
        #        -----BEGIN RSA PRIVATE KEY-----
        #        ...
        #        -----END RSA PRIVATE KEY-----
    zfs:
      datasetParentName: iocage/k8/nfs/vols
      detachedSnapshotsDatasetParentName: iocage/k8/nfs/snaps
      datasetEnableQuotas: true
      datasetEnableReservation: false
      datasetPermissionsMode: "0777"
      datasetPermissionsUser: 1000
      datasetPermissionsGroup: 1001
      datasetProperties:
        # TODO: change this to be a bit more readable
       "org.freenas:description": "{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}"
       "org.freenas:test": "{{ parameters.foo }}"
       "org.freenas:test2": "some value"
    nfs:
      shareHost: "{{ env TRUENAS_HOSTNAME }}"
      shareAlldirs: false
      shareAllowedHosts: []
      shareAllowedNetworks: []
      shareMaprootUser: root
      shareMaprootGroup: wheel
      shareMapallUser: ""
      shareMapallGroup: ""
